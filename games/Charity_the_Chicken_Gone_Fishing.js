const charity = "C";
const boat = "T";
const bubble = "B";
const fish = "F";
const water = "W";
const hook = "H";
//welcome to fishing!!!!! use your wasd keys to move. if on bubbles, press j and then spam j.
setLegend(
  [boat, bitmap`
................
................
................
................
................
..LL............
..LL............
.LL.............
.LL1111111111111
.LL1111111111111
.LL1111111111111
..L111111111111.
1.L.1111111111..
11L.111111111...
1...11111111....
................`],
  [charity, bitmap`
................
................
.......3333.....
......222222....
.....22222222...
.....22022202...
....2222222222..
...C2222262222C.
..CC2222222222CC
.....222CCC22...
.....22CCCCC2...
......CCCCCCC...
.......CCCCC....
................
................
................`],
  [bubble, bitmap`
................
................
................
................
......7.........
.....2..........
....2...........
.....72.........
....7...........
.....27.........
....7...........
......2.........
................
................
................
................`],
  [fish, bitmap`
................
................
......0000......
.....0F00F0.....
....0F0000F0....
.....0F00F0.....
......0000......
................
................
................
................
................
................
................
................
................`],
  [water, bitmap`
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555
5555555555555555`],
  [hook, bitmap`
................
................
................
................
................
................
.......0........
.......0........
.......0........
................
................
................
................
................
................
................`]
);

setMap(map`
WWWWWWWW
WWWWWWWW
WWWWWWWW
WWWWWWWW
WWWWWWWW
WWWWWWWW
WWWWWWWW
WWWWWWWW
`);

let boatSprite = addSprite(3, 3, boat);
let playerSprite = addSprite(3, 3, charity);

let score = 0;
let isFishing = false;
let catchCount = 0;
let catchGoal = 0;
let catchTimeout;

function drawScore() {
  clearText();
  addText(`Score: ${score}`, { x: 0, y: 0, color: color`4` });
}
drawScore();

// Bubble spawner
setInterval(() => {
  const x = Math.floor(Math.random() * 8);
  const y = Math.floor(Math.random() * 8);
  const occupied = getTile(x, y).some(s => [bubble, fish, hook, charity].includes(s.type));
  if (!occupied) {
    addSprite(x, y, bubble);
    setTimeout(() => {
      const b = getTile(x, y).find(s => s.type === bubble);
      if (b) b.remove();
    }, 4000);
  }
}, 1500);

// Movement
function movePlayer(dx, dy) {
  if (isFishing) return;
  const p = getFirst(charity);
  const b = getFirst(boat);
  if (!p || !b) return;
  const newX = Math.max(0, Math.min(7, p.x + dx));
  const newY = Math.max(0, Math.min(7, p.y + dy));
  p.x = newX;
  p.y = newY;
  b.x = newX;
  b.y = newY;
}

onInput("w", () => movePlayer(0, -1));
onInput("s", () => movePlayer(0, 1));
onInput("a", () => movePlayer(-1, 0));
onInput("d", () => movePlayer(1, 0));

// Fishing mechanic
onInput("j", () => {
  if (isFishing) {
    catchCount++;
    if (catchCount >= catchGoal) {
      clearTimeout(catchTimeout);
      addText("Fish Caught!", { y: 7, color: color`2` });
      score += catchGoal / 2;
      setTimeout(() => {
        clearText();
        isFishing = false;
        getAll(hook).forEach(h => h.remove());
        getAll(fish).forEach(f => f.remove());
        drawScore();
      }, 1000);
    }
    return;
  }

  const p = getFirst(charity);
  if (!p) return;

  const bubbleHere = getTile(p.x, p.y).find(s => s.type === bubble);
  if (bubbleHere) {
    const hookSprite = addSprite(p.x, p.y + 1, hook);
    const fishy = addSprite(p.x, p.y + 2, fish);
    const fishPoints = Math.floor(Math.random() * 100) + 1; // range 1â€“100
    catchGoal = fishPoints / 2;
    catchCount = 0;
    isFishing = true;

    addText("Spam J!", { y: 0, color: color`3` });

    catchTimeout = setTimeout(() => {
      if (isFishing) {
        isFishing = false;
        clearText();
        getAll(hook).forEach(h => h.remove());
        getAll(fish).forEach(f => f.remove());
        drawScore();
      }
    }, 10000); // Timeout in 10 seconds
  }
});
